# This is the SAM template that represents the architecture of your serverless application
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-basics.html

# The AWSTemplateFormatVersion identifies the capabilities of the template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/format-version-structure.html
AWSTemplateFormatVersion: 2010-09-09
Description: An AWS Serverless Application infrastructure for lp-is-gamestore project.

# Transform section specifies one or more macros that AWS CloudFormation uses to process your template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-section-structure.html
Transform:
- AWS::Serverless-2016-10-31

# Properties that are common to all your serverless functions, APIs, and simple tables. 
# All the AWS::Serverless::Function, AWS::Serverless::Api, and AWS::Serverless::SimpleTable resources 
# inherit the properties that are defined in the Globals section.
Globals:
  Api:    
    CacheClusterEnabled: true
    CacheClusterSize: "0.5"    
    MethodSettings:
    - HttpMethod: GET
      ResourcePath: /~1news~1*
      CachingEnabled: true
      CacheDataEncrypted: false
      CacheTtlInSeconds: 1200
      ThrottlingBurstLimit: TBD
      ThrottlingRateLimit: TBD
  HttpApi:
    Auth:
      DefaultAuthorizer: AWS_IAM
      EnableIamAuthorizer: true
    CorsConfiguration:
      AllowOrigins:
      - "*"
      AllowHeaders:
      - content-type
      - authorization
      - x-amz-content-sha256
      - x-amz-date
      - access-control-request-method
      - origin
      ExposeHeaders:
      - "*"
      AllowMethods:
      - GET
      - OPTIONS
      MaxAge: 600
      AllowCredentials: false
  Function:
    Environment:
      Variables:
        POWERTOOLS_SERVICE_NAME: powertools-dotnet-logging-sample
        POWERTOOLS_LOG_LEVEL: Debug

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:

  # Each Lambda function is defined by properties:
  # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
  # The Lambda function (support HTTP API) configs associated with the project: Gamestore.Serverless
  # The Lambda function returns a list of available games that are collected from different sources
  GamestoreServerlessGetAvailableGames:
    Type: AWS::Serverless::Function
    Metadata:
      Tool: Amazon.Lambda.Annotations
      SyncedEvents:
      - RootGet
      SyncedEventProperties:
        RootGet:
        - Path
        - Method
    Properties:
      Description: Get a list of available games from the Gamestore sources.
      Runtime: dotnet8
      CodeUri: ./src/Gamestore.Serverless/
      MemorySize: 128
      Timeout: 60
      Policies:
      - AWSLambdaBasicExecutionRole
      PackageType: Zip
      Handler: Gamestore.Serverless::Gamestore.Serverless.Functions_GetAvailableGamesAsync_Generated::GetAvailableGamesAsync
      Events:
        RootGet:
          Type: HttpApi
          Properties:
            Path: /availablegames
            Method: GET

  # The Lambda function (support HTTP API) configs associated with the project: Gamestore.Serverless
  # The Lambda function returns a news for specified game (by Id)
  GamestoreServerlessGetNews:
    Type: AWS::Serverless::Function
    Metadata: 
      Tool: Amazon.Lambda.Annotations
      SyncedEvents:
      - RootGet
      SyncedEventProperties:
        RootGet:
        - Path
        - Method
    Properties:
      Description: Get a news for specified game (by Id).
      Runtime: dotnet8
      CodeUri: ./src/Gamestore.Serverless/
      MemorySize: 128
      Timeout: 60
      Policies:
      - AWSLambdaBasicExecutionRole
      PackageType: Zip
      Handler: Gamestore.Serverless::Gamestore.Serverless.Functions_GetNewsAsync_Generated::GetNewsAsync
      Events:
        RootGet:
          Type: HttpApi
          Properties:
            Path: /news
            Method: GET

  # The Lambda function (support REST API) configs associated with the project: Gamestore.Serverless
  # The Lambda function returns a news for specified game (by Id)
  GamestoreServerlessGetNewsRestApi:
    Type: AWS::Serverless::Function
    Metadata:
      Tool: Amazon.Lambda.Annotations
      SyncedEvents:
      - RootGet
      SyncedEventProperties:
        RootGet:
        - Path
        - Method
    Properties:
      Description: Get a news for specified game (by Id).
      Runtime: dotnet8
      CodeUri: ./src/Gamestore.Serverless/
      MemorySize: 128
      Timeout: 60
      Policies:
      - AWSLambdaBasicExecutionRole
      PackageType: Zip
      Handler: Gamestore.Serverless::Gamestore.Serverless.Functions_GetNewsRestApiAsync_Generated::GetNewsRestApiAsync
      Events:
        RootGet:
          Type: Api
          Properties:
            Path: /news/{gameId}
            Method: GET
Outputs:
  ApiURL:
    Description: API endpoint URL
    Value:
      Fn::Sub: https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com/